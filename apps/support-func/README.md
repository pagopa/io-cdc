# Azure Function Template

This Workspace is a template to implement an Azure Function for simple REST API.

## Architecture

The project is structured as follows:

```
azure-functions-api
|-- api
|-- src
|   |-- functions
|   |-- generated
|   |-- middlewares
|   |-- models
|   |-- utils
|   |   |-- cosmos
|   |   |-- redis
|   |-- config.ts
|   |-- main.ts
|-- package.json
|-- host.json
```

- The `api` folder contains all the internal and external OpenAPI specification.
- The `src` folder contain all the implementation of the functions

### src Folder

The `src` folder contains the `main.ts` file that exports the implementation for all the functions defined in this workspace. The Azure Core Function V4 runtime is required to execute it.

#### functions Folder

Contains the implementation of the functions handlers

#### generated Folder

This folder contains the autogenerated code from type definitions in OpenApi specs located into the `api` folder. The command `pnpm generate` start the generation process.

#### models Folder

Containst the file for the model layer of the function, that allows to access to databases (Redis and Cosmos for example).

#### middlewares Folder

Contains middlewares for local business logic, that in not usefull to share with other workspaces in the same monorepo but can be shared across multiple functions in the same applicative.

## ENV variables

The following table contains the required ENV variables that the applicative require

| Variable name                           | Description                                                        | type    |
|-----------------------------------------|--------------------------------------------------------------------|---------|
| APPLICATIONINSIGHTS_CONNECTION_STRING   | The Application Insights connection string                         | string  |
| COSMOSDB_CDC_URI                        | The CosmosDB endpoint URI                                          | string  |
| COSMOSDB_CDC_DATABASE_NAME              | The CosmosDB database name                                         | string  |
| FETCH_TIMEOUT_MS                        | (optional) Fetch Timeout for AbortableFetch                        | number  |

> **Note:** CosmosDB authentication uses Azure RBAC via `DefaultAzureCredential` (managed identity).  
> No connection key (`COSMOSDB_CDC_KEY`) is required. The function's managed identity must be assigned  
> the `Cosmos DB Built-in Data Contributor` role on the CosmosDB account.  
> For local development, ensure you are logged in via `az login` or have a suitable credential configured.

## Local Execution

To execute locally the function copy the configuration from the `env.example` file with:

```bash
cp env.example .env
```

Then you can start the function using the following command:
```bash
pnpm start
```

## Integration test

not yet included

### Testing models

not yet included

